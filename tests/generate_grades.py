grades = {
    "finalGrade": {
        "value": 7.1,
        "isVisible": True,
        "formula": ""
    },
    "structure": [
        {
            "gradeCategoryAcademicMainId": 1417430,
            "id": 1260792,
            "name": "Atividade Avaliativa 01",
            "sequence": 1,
            "categoryFormula": {
                "front": [
                    {
                        "type": "variable",
                        "value": 2,
                        "variable": "x2"
                    }
                ],
                "back": "x2"
            },
            "value": 2.1,
            "children": [
                {
                    "gradeCategoryAcademicMainId": 1417430,
                    "id": 2940805,
                    "name": "Tarefa Avaliativa",
                    "participationWeight": None,
                    "maxValue": 3,
                    "value": 2.1,
                    "hasDeadline": True,
                    "deadlineAt": "2025-06-15T02:59:00.000Z",
                    "topicTypeId": 8,
                    "categoryTypeId": 5,
                    "isSubmited": True,
                    "submitedAt": "2025-06-03T02:34:54.212Z",
                    "isRevised": True,
                    "isDeadlineExpired": True,
                    "children": []
                }
            ]
        },
        {
            "gradeCategoryAcademicMainId": 1417431,
            "id": 1260793,
            "name": "Aulas - Unidades de Aprendizagem",
            "sequence": 2,
            "categoryFormula": {
                "front": [
                    {
                        "type": "function",
                        "value": "mean",
                        "variable": "mean(x1,x2,x3,x4,x5,x6,x7,x8,x9,x10)"
                    },
                    {
                        "type": "arithmetical",
                        "value": " / ",
                        "variable": " / "
                    },
                    {
                        "type": "equalValue",
                        "value": "",
                        "variable": "100"
                    }
                ],
                "back": "mean(x1,x2,x3,x4,x5,x6,x7,x8,x9,x10) / 100"
            },
            "value": 1,
            "children": [
                {
                    "gradeCategoryAcademicMainId": 1417431,
                    "id": 2942704,
                    "name": "Identifica\u00e7\u00e3o e an\u00e1lise de oportunidades nacionais e internacionais",
                    "participationWeight": 100,
                    "maxValue": 100,
                    "value": 100,
                    "hasDeadline": True,
                    "deadlineAt": "2025-06-27T02:59:00.000Z",
                    "topicTypeId": 2,
                    "categoryTypeId": 1,
                    "isSubmited": False,
                    "submitedAt": None,
                    "isRevised": True,
                    "isDeadlineExpired": True,
                    "children": [
                        {
                            "name": "Participa\u00e7\u00e3o",
                            "maxValue": 100,
                            "deadlineAt": "2025-06-27T02:59:00.000Z",
                            "isDeadlineExpired": True,
                            "partialValue": 100,
                            "value": 100,
                            "isParticipation": True,
                            "hasAccessedAllItems": True,
                            "items": [
                                {
                                    "name": "Na pr\u00e1tica",
                                    "value": 10,
                                    "weight": 10,
                                    "isAccessed": True
                                },
                                {
                                    "name": "Conte\u00fado do Livro",
                                    "value": 10,
                                    "weight": 10,
                                    "isAccessed": True
                                },
                                {
                                    "name": "Dica do Professor",
                                    "value": 10,
                                    "weight": 10,
                                    "isAccessed": True
                                },
                                {
                                    "name": "Infogr\u00e1fico",
                                    "value": 5,
                                    "weight": 5,
                                    "isAccessed": True
                                },
                                {
                                    "name": "Exerc\u00edcios",
                                    "value": 60,
                                    "weight": 60,
                                    "isAccessed": True
                                },
                                {
                                    "name": "Apresenta\u00e7\u00e3o",
                                    "value": 5,
                                    "weight": 5,
                                    "isAccessed": True
                                }
                            ]
                        }
                    ]
                },
                {
                    "gradeCategoryAcademicMainId": 1417431,
                    "id": 2942705,
                    "name": "Plano de marketing",
                    "participationWeight": 100,
                    "maxValue": 100,
                    "value": 100,
                    "hasDeadline": True,
                    "deadlineAt": "2025-06-27T02:59:00.000Z",
                    "topicTypeId": 2,
                    "categoryTypeId": 1,
                    "isSubmited": False,
                    "submitedAt": None,
                    "isRevised": True,
                    "isDeadlineExpired": True,
                    "children": [
                        {
                            "name": "Participa\u00e7\u00e3o",
                            "maxValue": 100,
                            "deadlineAt": "2025-06-27T02:59:00.000Z",
                            "isDeadlineExpired": True,
                            "partialValue": 100,
                            "value": 100,
                            "isParticipation": True,
                            "hasAccessedAllItems": True,
                            "items": [
                                {
                                    "name": "Apresenta\u00e7\u00e3o",
                                    "value": 5,
                                    "weight": 5,
                                    "isAccessed": True
                                },
                                {
                                    "name": "Na pr\u00e1tica",
                                    "value": 10,
                                    "weight": 10,
                                    "isAccessed": True
                                },
                                {
                                    "name": "Dica do Professor",
                                    "value": 10,
                                    "weight": 10,
                                    "isAccessed": True
                                },
                                {
                                    "name": "Conte\u00fado do Livro",
                                    "value": 10,
                                    "weight": 10,
                                    "isAccessed": True
                                },
                                {
                                    "name": "Exerc\u00edcios",
                                    "value": 60,
                                    "weight": 60,
                                    "isAccessed": True
                                },
                                {
                                    "name": "Infogr\u00e1fico",
                                    "value": 5,
                                    "weight": 5,
                                    "isAccessed": True
                                }
                            ]
                        }
                    ]
                },
                {
                    "gradeCategoryAcademicMainId": 1417431,
                    "id": 2942706,
                    "name": "Plano de neg\u00f3cio: criando e dando in\u00edcio ao empreendimento",
                    "participationWeight": 100,
                    "maxValue": 100,
                    "value": 100,
                    "hasDeadline": True,
                    "deadlineAt": "2025-06-27T02:59:00.000Z",
                    "topicTypeId": 2,
                    "categoryTypeId": 1,
                    "isSubmited": False,
                    "submitedAt": None,
                    "isRevised": True,
                    "isDeadlineExpired": True,
                    "children": [
                        {
                            "name": "Participa\u00e7\u00e3o",
                            "maxValue": 100,
                            "deadlineAt": "2025-06-27T02:59:00.000Z",
                            "isDeadlineExpired": True,
                            "partialValue": 100,
                            "value": 100,
                            "isParticipation": True,
                            "hasAccessedAllItems": True,
                            "items": [
                                {
                                    "name": "Na pr\u00e1tica",
                                    "value": 10,
                                    "weight": 10,
                                    "isAccessed": True
                                },
                                {
                                    "name": "Dica do Professor",
                                    "value": 10,
                                    "weight": 10,
                                    "isAccessed": True
                                },
                                {
                                    "name": "Exerc\u00edcios",
                                    "value": 60,
                                    "weight": 60,
                                    "isAccessed": True
                                },
                                {
                                    "name": "Conte\u00fado do Livro",
                                    "value": 10,
                                    "weight": 10,
                                    "isAccessed": True
                                },
                                {
                                    "name": "Apresenta\u00e7\u00e3o",
                                    "value": 5,
                                    "weight": 5,
                                    "isAccessed": True
                                },
                                {
                                    "name": "Infogr\u00e1fico",
                                    "value": 5,
                                    "weight": 5,
                                    "isAccessed": True
                                }
                            ]
                        }
                    ]
                },
                {
                    "gradeCategoryAcademicMainId": 1417431,
                    "id": 2942707,
                    "name": "Criatividade e a ideia da empresa",
                    "participationWeight": 100,
                    "maxValue": 100,
                    "value": 100,
                    "hasDeadline": True,
                    "deadlineAt": "2025-06-27T02:59:00.000Z",
                    "topicTypeId": 2,
                    "categoryTypeId": 1,
                    "isSubmited": False,
                    "submitedAt": None,
                    "isRevised": True,
                    "isDeadlineExpired": True,
                    "children": [
                        {
                            "name": "Participa\u00e7\u00e3o",
                            "maxValue": 100,
                            "deadlineAt": "2025-06-27T02:59:00.000Z",
                            "isDeadlineExpired": True,
                            "partialValue": 100,
                            "value": 100,
                            "isParticipation": True,
                            "hasAccessedAllItems": True,
                            "items": [
                                {
                                    "name": "Infogr\u00e1fico",
                                    "value": 5,
                                    "weight": 5,
                                    "isAccessed": True
                                },
                                {
                                    "name": "Apresenta\u00e7\u00e3o",
                                    "value": 5,
                                    "weight": 5,
                                    "isAccessed": True
                                },
                                {
                                    "name": "Dica do Professor",
                                    "value": 10,
                                    "weight": 10,
                                    "isAccessed": True
                                },
                                {
                                    "name": "Conte\u00fado do Livro",
                                    "value": 10,
                                    "weight": 10,
                                    "isAccessed": True
                                },
                                {
                                    "name": "Na pr\u00e1tica",
                                    "value": 10,
                                    "weight": 10,
                                    "isAccessed": True
                                },
                                {
                                    "name": "Exerc\u00edcios",
                                    "value": 60,
                                    "weight": 60,
                                    "isAccessed": True
                                }
                            ]
                        }
                    ]
                },
                {
                    "gradeCategoryAcademicMainId": 1417431,
                    "id": 2942708,
                    "name": "A prote\u00e7\u00e3o da ideia e outras quest\u00f5es legais para o empreendedor",
                    "participationWeight": 100,
                    "maxValue": 100,
                    "value": 100,
                    "hasDeadline": True,
                    "deadlineAt": "2025-06-27T02:59:00.000Z",
                    "topicTypeId": 2,
                    "categoryTypeId": 1,
                    "isSubmited": False,
                    "submitedAt": None,
                    "isRevised": True,
                    "isDeadlineExpired": True,
                    "children": [
                        {
                            "name": "Participa\u00e7\u00e3o",
                            "maxValue": 100,
                            "deadlineAt": "2025-06-27T02:59:00.000Z",
                            "isDeadlineExpired": True,
                            "partialValue": 100,
                            "value": 100,
                            "isParticipation": True,
                            "hasAccessedAllItems": True,
                            "items": [
                                {
                                    "name": "Na pr\u00e1tica",
                                    "value": 10,
                                    "weight": 10,
                                    "isAccessed": True
                                },
                                {
                                    "name": "Conte\u00fado do Livro",
                                    "value": 10,
                                    "weight": 10,
                                    "isAccessed": True
                                },
                                {
                                    "name": "Dica do Professor",
                                    "value": 10,
                                    "weight": 10,
                                    "isAccessed": True
                                },
                                {
                                    "name": "Infogr\u00e1fico",
                                    "value": 5,
                                    "weight": 5,
                                    "isAccessed": True
                                },
                                {
                                    "name": "Exerc\u00edcios",
                                    "value": 60,
                                    "weight": 60,
                                    "isAccessed": True
                                },
                                {
                                    "name": "Apresenta\u00e7\u00e3o",
                                    "value": 5,
                                    "weight": 5,
                                    "isAccessed": True
                                }
                            ]
                        }
                    ]
                },
                {
                    "gradeCategoryAcademicMainId": 1417431,
                    "id": 2942709,
                    "name": "Plano organizacional",
                    "participationWeight": 100,
                    "maxValue": 100,
                    "value": 100,
                    "hasDeadline": True,
                    "deadlineAt": "2025-06-27T02:59:00.000Z",
                    "topicTypeId": 2,
                    "categoryTypeId": 1,
                    "isSubmited": False,
                    "submitedAt": None,
                    "isRevised": True,
                    "isDeadlineExpired": True,
                    "children": [
                        {
                            "name": "Participa\u00e7\u00e3o",
                            "maxValue": 100,
                            "deadlineAt": "2025-06-27T02:59:00.000Z",
                            "isDeadlineExpired": True,
                            "partialValue": 100,
                            "value": 100,
                            "isParticipation": True,
                            "hasAccessedAllItems": True,
                            "items": [
                                {
                                    "name": "Conte\u00fado do Livro",
                                    "value": 10,
                                    "weight": 10,
                                    "isAccessed": True
                                },
                                {
                                    "name": "Infogr\u00e1fico",
                                    "value": 5,
                                    "weight": 5,
                                    "isAccessed": True
                                },
                                {
                                    "name": "Apresenta\u00e7\u00e3o",
                                    "value": 5,
                                    "weight": 5,
                                    "isAccessed": True
                                },
                                {
                                    "name": "Exerc\u00edcios",
                                    "value": 60,
                                    "weight": 60,
                                    "isAccessed": True
                                },
                                {
                                    "name": "Dica do Professor",
                                    "value": 10,
                                    "weight": 10,
                                    "isAccessed": True
                                },
                                {
                                    "name": "Na pr\u00e1tica",
                                    "value": 10,
                                    "weight": 10,
                                    "isAccessed": True
                                }
                            ]
                        }
                    ]
                },
                {
                    "gradeCategoryAcademicMainId": 1417431,
                    "id": 2942710,
                    "name": "O empreendedorismo e a mentalidade empreendedora",
                    "participationWeight": 100,
                    "maxValue": 100,
                    "value": 100,
                    "hasDeadline": True,
                    "deadlineAt": "2025-06-27T02:59:00.000Z",
                    "topicTypeId": 2,
                    "categoryTypeId": 1,
                    "isSubmited": False,
                    "submitedAt": None,
                    "isRevised": True,
                    "isDeadlineExpired": True,
                    "children": [
                        {
                            "name": "Participa\u00e7\u00e3o",
                            "maxValue": 100,
                            "deadlineAt": "2025-06-27T02:59:00.000Z",
                            "isDeadlineExpired": True,
                            "partialValue": 100,
                            "value": 100,
                            "isParticipation": True,
                            "hasAccessedAllItems": True,
                            "items": [
                                {
                                    "name": "Apresenta\u00e7\u00e3o",
                                    "value": 5,
                                    "weight": 5,
                                    "isAccessed": True
                                },
                                {
                                    "name": "Dica do Professor",
                                    "value": 10,
                                    "weight": 10,
                                    "isAccessed": True
                                },
                                {
                                    "name": "Na pr\u00e1tica",
                                    "value": 10,
                                    "weight": 10,
                                    "isAccessed": True
                                },
                                {
                                    "name": "Conte\u00fado do Livro",
                                    "value": 10,
                                    "weight": 10,
                                    "isAccessed": True
                                },
                                {
                                    "name": "Exerc\u00edcios",
                                    "value": 60,
                                    "weight": 60,
                                    "isAccessed": True
                                },
                                {
                                    "name": "Infogr\u00e1fico",
                                    "value": 5,
                                    "weight": 5,
                                    "isAccessed": True
                                }
                            ]
                        }
                    ]
                },
                {
                    "gradeCategoryAcademicMainId": 1417431,
                    "id": 2942711,
                    "name": "Empreendedorismo corporativo",
                    "participationWeight": 100,
                    "maxValue": 100,
                    "value": 100,
                    "hasDeadline": True,
                    "deadlineAt": "2025-06-27T02:59:00.000Z",
                    "topicTypeId": 2,
                    "categoryTypeId": 1,
                    "isSubmited": False,
                    "submitedAt": None,
                    "isRevised": True,
                    "isDeadlineExpired": True,
                    "children": [
                        {
                            "name": "Participa\u00e7\u00e3o",
                            "maxValue": 100,
                            "deadlineAt": "2025-06-27T02:59:00.000Z",
                            "isDeadlineExpired": True,
                            "partialValue": 100,
                            "value": 100,
                            "isParticipation": True,
                            "hasAccessedAllItems": True,
                            "items": [
                                {
                                    "name": "Na pr\u00e1tica",
                                    "value": 10,
                                    "weight": 10,
                                    "isAccessed": True
                                },
                                {
                                    "name": "Dica do Professor",
                                    "value": 10,
                                    "weight": 10,
                                    "isAccessed": True
                                },
                                {
                                    "name": "Apresenta\u00e7\u00e3o",
                                    "value": 5,
                                    "weight": 5,
                                    "isAccessed": True
                                },
                                {
                                    "name": "Infogr\u00e1fico",
                                    "value": 5,
                                    "weight": 5,
                                    "isAccessed": True
                                },
                                {
                                    "name": "Conte\u00fado do Livro",
                                    "value": 10,
                                    "weight": 10,
                                    "isAccessed": True
                                },
                                {
                                    "name": "Exerc\u00edcios",
                                    "value": 60,
                                    "weight": 60,
                                    "isAccessed": True
                                }
                            ]
                        }
                    ]
                },
                {
                    "gradeCategoryAcademicMainId": 1417431,
                    "id": 2942712,
                    "name": "Estrat\u00e9gia empreendedora: gera\u00e7\u00e3o e explora\u00e7\u00e3o de novas entradas",
                    "participationWeight": 100,
                    "maxValue": 100,
                    "value": 100,
                    "hasDeadline": True,
                    "deadlineAt": "2025-06-27T02:59:00.000Z",
                    "topicTypeId": 2,
                    "categoryTypeId": 1,
                    "isSubmited": False,
                    "submitedAt": None,
                    "isRevised": True,
                    "isDeadlineExpired": True,
                    "children": [
                        {
                            "name": "Participa\u00e7\u00e3o",
                            "maxValue": 100,
                            "deadlineAt": "2025-06-27T02:59:00.000Z",
                            "isDeadlineExpired": True,
                            "partialValue": 100,
                            "value": 100,
                            "isParticipation": True,
                            "hasAccessedAllItems": True,
                            "items": [
                                {
                                    "name": "Conte\u00fado do Livro",
                                    "value": 10,
                                    "weight": 10,
                                    "isAccessed": True
                                },
                                {
                                    "name": "Dica do Professor",
                                    "value": 10,
                                    "weight": 10,
                                    "isAccessed": True
                                },
                                {
                                    "name": "Exerc\u00edcios",
                                    "value": 60,
                                    "weight": 60,
                                    "isAccessed": True
                                },
                                {
                                    "name": "Infogr\u00e1fico",
                                    "value": 5,
                                    "weight": 5,
                                    "isAccessed": True
                                },
                                {
                                    "name": "Apresenta\u00e7\u00e3o",
                                    "value": 5,
                                    "weight": 5,
                                    "isAccessed": True
                                },
                                {
                                    "name": "Na pr\u00e1tica",
                                    "value": 10,
                                    "weight": 10,
                                    "isAccessed": True
                                }
                            ]
                        }
                    ]
                },
                {
                    "gradeCategoryAcademicMainId": 1417431,
                    "id": 2942713,
                    "name": "O perfil do empreendedor: hist\u00f3rico e caracter\u00edsticas",
                    "participationWeight": 100,
                    "maxValue": 100,
                    "value": 100,
                    "hasDeadline": True,
                    "deadlineAt": "2025-06-27T02:59:00.000Z",
                    "topicTypeId": 2,
                    "categoryTypeId": 1,
                    "isSubmited": False,
                    "submitedAt": None,
                    "isRevised": True,
                    "isDeadlineExpired": True,
                    "children": [
                        {
                            "name": "Participa\u00e7\u00e3o",
                            "maxValue": 100,
                            "deadlineAt": "2025-06-27T02:59:00.000Z",
                            "isDeadlineExpired": True,
                            "partialValue": 100,
                            "value": 100,
                            "isParticipation": True,
                            "hasAccessedAllItems": True,
                            "items": [
                                {
                                    "name": "Na pr\u00e1tica",
                                    "value": 10,
                                    "weight": 10,
                                    "isAccessed": True
                                },
                                {
                                    "name": "Conte\u00fado do Livro",
                                    "value": 10,
                                    "weight": 10,
                                    "isAccessed": True
                                },
                                {
                                    "name": "Infogr\u00e1fico",
                                    "value": 5,
                                    "weight": 5,
                                    "isAccessed": True
                                },
                                {
                                    "name": "Dica do Professor",
                                    "value": 10,
                                    "weight": 10,
                                    "isAccessed": True
                                },
                                {
                                    "name": "Apresenta\u00e7\u00e3o",
                                    "value": 5,
                                    "weight": 5,
                                    "isAccessed": True
                                },
                                {
                                    "name": "Exerc\u00edcios",
                                    "value": 60,
                                    "weight": 60,
                                    "isAccessed": True
                                }
                            ]
                        }
                    ]
                }
            ]
        },
        {
            "gradeCategoryAcademicMainId": 1417434,
            "id": 1260796,
            "name": "Avalia\u00e7\u00e3o Presencial",
            "sequence": 4,
            "categoryFormula": {
                "front": [
                    {
                        "type": "variable",
                        "value": 3,
                        "variable": "x3"
                    },
                    {
                        "type": "arithmetical",
                        "value": " * ",
                        "variable": " * "
                    },
                    {
                        "type": "equalValue",
                        "value": "",
                        "variable": "0.6"
                    }
                ],
                "back": "x3 * 0.6"
            },
            "value": 3,
            "children": []
        },
        {
            "gradeCategoryAcademicMainId": 1417435,
            "id": 1260797,
            "name": "SIMULADO (ponto extra)",
            "sequence": 5,
            "categoryFormula": {},
            "value": 1,
            "children": []
        },
        {
            "gradeCategoryAcademicMainId": 1417437,
            "id": 1260799,
            "name": "Avalia\u00e7\u00e3o Exame",
            "sequence": 8,
            "categoryFormula": {
                "front": [
                    {
                        "type": "variable",
                        "value": 7,
                        "variable": "x7"
                    },
                    {
                        "type": "arithmetical",
                        "value": " * ",
                        "variable": " * "
                    },
                    {
                        "type": "equalValue",
                        "value": "",
                        "variable": "0.4"
                    }
                ],
                "back": "x7 * 0.4"
            },
            "value": 0,
            "children": []
        },
        {
            "gradeCategoryAcademicMainId": 1417438,
            "id": 1260800,
            "name": "C\u00e1lculo Nota Exame",
            "sequence": 9,
            "categoryFormula": {
                "front": [
                    {
                        "type": "arithmetical",
                        "value": "(",
                        "variable": "("
                    },
                    {
                        "type": "variable",
                        "value": "11",
                        "variable": "x4"
                    },
                    {
                        "type": "arithmetical",
                        "value": " * ",
                        "variable": " * "
                    },
                    {
                        "type": "equalValue",
                        "value": "",
                        "variable": "0.6"
                    },
                    {
                        "type": "arithmetical",
                        "value": ")",
                        "variable": ")"
                    },
                    {
                        "type": "arithmetical",
                        "value": " + ",
                        "variable": " + "
                    },
                    {
                        "type": "variable",
                        "value": "4",
                        "variable": "x8"
                    }
                ],
                "back": "(x4 * 0.6) + x8"
            },
            "value": 4.26,
            "children": []
        }
    ]
}

from datetime import datetime
from typing import Dict, List, Any


def format_grades_message(grades_data: Dict) -> str:
    """
    Formata os dados das notas numa mensagem legível com emojis e Markdown para Telegram.
    """

    def format_date(date_str: str) -> str:
        try:
            if not date_str:
                return "Sem prazo"
            dt = datetime.fromisoformat(date_str.replace("Z", "+00:00"))
            return dt.strftime("%d/%m/%Y às %H:%M")
        except Exception:
            return "Data inválida"

    def get_status_emoji(is_submited: bool, is_revised: bool, is_deadline_expired: bool) -> str:
        if is_submited and is_revised:
            return "✅ Entregue e Corrigido"
        elif is_submited:
            return "📤 Entregue"
        elif is_deadline_expired:
            return "⏰ Prazo Expirado"
        else:
            return "⏳ Pendente"

    discipline_name = grades_data.get('discipline_name', '📚 Disciplina Não Identificada')
    structure = grades_data.get('structure', [])
    final_grade = grades_data.get('finalGrade', {}).get('value', 0)
    final_grade_visible = grades_data.get('finalGrade', {}).get('isVisible', True)

    if final_grade >= 7.0:
        status = "✅ Aprovado"
        status_emoji = "🎉"
    elif final_grade >= 5.0:
        status = "⚠️ Recuperação"
        status_emoji = "📚"
    else:
        status = "❌ Reprovado"
        status_emoji = "😞"

    message = f"{status_emoji} **{discipline_name}**\n"
    message += f"{'═' * 30}\n\n"

    for category in structure:
        category_name = category.get("name", "Categoria")
        category_value = category.get("value", 0)
        sequence = category.get("sequence", 0)

        if "Atividade" in category_name:
            emoji = "📝"
        elif "Aulas" in category_name or "Unidades" in category_name:
            emoji = "📚"
        elif "Presencial" in category_name:
            emoji = "🏫"
        elif "SIMULADO" in category_name or "extra" in category_name:
            emoji = "🎯"
        elif "Exame" in category_name:
            emoji = "📋"
        else:
            emoji = "📊"

        message += f"{emoji} **{category_name}**\n"
        message += f"📈 Nota: {category_value}"

        formula = category.get("categoryFormula", {}).get("back", "")
        if formula and len(formula) > 0 and not 'mean' in formula.lower():
            message += f"\n🧮 Fórmula: {formula}"

        children = category.get("children", [])
        if children:
            message += "\n\n📋 **Detalhes:**\n"

            for child in children:
                child_name = child.get("name", "Item")
                child_value = child.get("value", 0)
                max_value = child.get("maxValue", 0)
                is_submited = child.get("isSubmited", False)
                is_revised = child.get("isRevised", False)
                is_deadline_expired = child.get("isDeadlineExpired", False)
                deadline = child.get("deadlineAt", "")

                status_text = get_status_emoji(is_submited, is_revised, is_deadline_expired)

                child_children = child.get("children", [])
                has_participation = any(
                    item.get("isParticipation", False) for item in child_children
                )

                if has_participation and child_children:
                    participation = child_children[0]  # Primeiro item é sempre a participação
                    items = participation.get("items", [])
                    has_accessed_all = participation.get("hasAccessedAllItems", False)

                    message += f"\n• 🧠 **{child_name}**\n"
                    message += f"  📊 Nota: {child_value}/{max_value}\n"
                    message += f"  ⏰ Prazo: {format_date(deadline)}\n"
                    message += f"  🎯 Acesso: {'✅ Completo' if has_accessed_all else '⚠️ Incompleto'}\n"

                    """if items:
                        message += f"  📚 **Atividades:**\n"
                        for item in items:
                            item_name = item.get("name", "Item")
                            item_value = item.get("value", 0)
                            item_weight = item.get("weight", 0)
                            is_accessed = item.get("isAccessed", False)
                            access_emoji = "✅" if is_accessed else "❌"

                            message += f"    ├─ {access_emoji} *{item_name}* ({item_value}/{item_weight})\n"""
                else:
                    message += f"\n• 📝 **{child_name}**\n"
                    message += f"  📊 Nota: {child_value}/{max_value}\n"
                    message += f"  ⏰ Prazo: {format_date(deadline)}\n"
                    message += f"  📋 Status: {status_text}\n"

        message += f"\n{'─' * 20}\n"

    message += f"\n🎯 **RESULTADO FINAL**\n"
    if final_grade_visible:
        message += f"📊 **Nota Final:** {final_grade}\n"
    else:
        message += f"📊 **Nota Final:** Oculta\n"

    message += f"🏆 **Status:** {status}\n"

    total_activities = sum(len(cat.get("children", [])) for cat in structure)
    completed_activities = sum(
        len([child for child in cat.get("children", [])
             if child.get("isSubmited", False) or
             any(item.get("hasAccessedAllItems", False)
                 for item in child.get("children", []))])
        for cat in structure
    )

    if total_activities > 0:
        completion_rate = (completed_activities / total_activities) * 100
        message += f"\n📈 **Taxa de Conclusão:** {completion_rate:.1f}%\n"

    if final_grade >= 7.0:
        message += f"\n🎉 **Parabéns! Você foi aprovado!**\n"
    elif final_grade >= 5.0:
        message += f"\n📚 **Atenção: Você está em recuperação**\n"
        message += f"💪 Estude para a prova final!\n"
    else:
        message += f"\n😔 **Você foi reprovado nesta disciplina**"
        message += f"💪 Não desista, tente novamente!\n"

    message += f"\n🤖 __Atualizado em {datetime.now().strftime('%d/%m/%Y às %H:%M')}__"

    return message


def test_formatter():
    """
    Função de teste com dados de exemplo
    """
    sample_data = {
        "discipline_name": "Empreendedorismo",
        "finalGrade": {
            "value": 7.1,
            "isVisible": True,
            "formula": ""
        },
        "structure": [
            {
                "name": "Atividade Avaliativa 01",
                "sequence": 1,
                "value": 2.1,
                "children": [
                    {
                        "name": "Tarefa Avaliativa",
                        "maxValue": 3,
                        "value": 2.1,
                        "hasDeadline": True,
                        "deadlineAt": "2025-06-15T02:59:00.000Z",
                        "isSubmited": True,
                        "submitedAt": "2025-06-03T02:34:54.212Z",
                        "isRevised": True,
                        "isDeadlineExpired": True,
                        "children": []
                    }
                ]
            }
        ]
    }

    return format_grades_message(grades)


if __name__ == "__main__":
    print(test_formatter())